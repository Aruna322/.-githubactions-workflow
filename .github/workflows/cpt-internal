name: CPT-InternalConsumer

on:
  push:
    branches: [ main ]   # change if needed
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout Internal Consumer repo
      - uses: actions/checkout@v4

      # 2) Checkout Search Widget
      - name: Checkout Search Widget
        uses: actions/checkout@v4
        with:
          repository: E2E/competitor-product-search-widget
          path: cpt-search-widget

      # 3) Checkout Product Listing
      - name: Checkout Product Listing
        uses: actions/checkout@v4
        with:
          repository: E2E/competitor-product-listing
          path: cpt-product-listing

      # 4) Setup Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 5) Build all three apps
      - name: Build Search Widget
        working-directory: cpt-search-widget
        run: |
          npm install
          npm run build

      - name: Build Product Listing
        working-directory: cpt-product-listing
        run: |
          npm install
          npm run build

      - name: Build Internal Consumer
        run: |
          npm install
          npm run build

      # 6) Prepare final folder + zip
      - name: Package Internal Consumer
        run: |
          mv public competitor-product-internal-consumer

          rm -rf competitor-product-internal-consumer/assets/competitor-product-listing \
                 competitor-product-internal-consumer/assets/competitor-product-search-widget

          mkdir -p competitor-product-internal-consumer/assets

          cp -r cpt-search-widget/public/assets/competitor-product-search-widget \
                competitor-product-internal-consumer/assets

          cp -r cpt-product-listing/public/assets/competitor-product-listing \
                competitor-product-internal-consumer/assets

          zip -r competitor-product-internal-consumer.zip competitor-product-internal-consumer

      # 7) Setup SSH
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "${{ secrets.SSH_HOST }}" >> ~/.ssh/known_hosts

      # 8) Copy zip to server
      - name: Upload package
        run: |
          scp competitor-product-internal-consumer.zip \
            "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home/GAD/srv992840/CPT-releases-ANG/"

      # 9) Run deploy script on server
      - name: Run remote deploy
        run: |
          ssh "${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}" << 'EOF'
            chmod -R 777 /home/GAD/srv992840/CPT-releases-ANG/
            sudo -u ecofit /app/ecofit/competitor-product-tool/se/deployement/cpt-consumer.sh
            rm -rf /home/GAD/srv992840/CPT-releases-ANG/*
          EOF
