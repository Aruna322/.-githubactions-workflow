name: CPT-ProductListing CI + Security Scans

on:
  push:
    branches:
      - main          # change if your branch is different
  workflow_dispatch:  # manual trigger

jobs:
  build-and-scan:
    # Use your self-hosted runner where Black Duck & Fortify are installed
    runs-on: self-hosted

    env:
      BLACKDUCK_URL: https://blackduck.eu.se.com/
      FORTIFY_URL: https://wfsiaprd12196.gad.schneider-electric.com
      FORTIFY_PROJECT: CPT-ProductListing
      FORTIFY_FPR: cpt.product-listing1.fpr

    steps:
      # 1. Get code
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. Setup Node
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # 3. Install dependencies
      - name: Install dependencies
        run: npm install --legacy-peer-deps

      # 4. Build app
      - name: Build app
        run: npm run build

      # 5. Black Duck (Synopsys Detect)
      - name: Run Black Duck scan
        run: >
          java -jar /app/Synopsys/synopsys-detect-9.9.0.jar
          --blackduck.url=$BLACKDUCK_URL
          --blackduck.api.token=${{ secrets.BLACKDUCK_API_TOKEN }}
          --detect.project.name="CPT-Product Listing UIaaS"
          --detect.project.version.name=1.22.0
          --detect.source.path=.

      # 6. Fortify – update rules
      - name: Fortify update rules
        run: |
          /app/Fortify/Fortify_SCA_24.2.0/bin/fortifyupdate -url "$FORTIFY_URL"
          /app/Fortify/Fortify_SCA_24.2.0/bin/fortifyupdate -showInstalledRules

      # 7. Fortify – translate & scan
      - name: Fortify translate and scan
        run: |
          /app/Fortify/Fortify_SCA_24.2.0/bin/sourceanalyzer -b "$FORTIFY_PROJECT" -clean
          /app/Fortify/Fortify_SCA_24.2.0/bin/sourceanalyzer -b "$FORTIFY_PROJECT" .
          /app/Fortify/Fortify_SCA_24.2.0/bin/sourceanalyzer -b "$FORTIFY_PROJECT" -scan \
            -f "$FORTIFY_FPR" \
            -verbose \
            -logfile fortify-scan.log

      # 8. Save Fortify report as artifact (optional but useful)
      - name: Upload Fortify report
        uses: actions/upload-artifact@v4
        with:
          name: fortify-fpr
          path: ${{ env.FORTIFY_FPR }}
