name: CPT Partner Consumer CI

on:
  push:
    branches:
      - main
      - CPT_GUI_3.12-RC1     # same branch you were building in Jenkins
  pull_request:
    branches:
      - main
  workflow_dispatch:         # manual trigger

jobs:
  build-test-scan:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up Java 11 (Jenkins finally used JDK 11)
      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      # 3. Build with Maven (clean + install like Jenkins)
      - name: Build with Maven
        run: mvn -B clean install

      # 4. Upload built WAR as pipeline artifact (instead of Jenkins archive)
      - name: Upload WAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: se-cpt-public-consumer-war
          path: target/*.war

      # 5. Black Duck scan (equivalent to synopsys-detect JAR) — OPTIONAL
      #    Set these in GitHub repo Settings → Secrets and variables → Actions:
      #    BLACKDUCK_URL, BLACKDUCK_API_TOKEN
      - name: Black Duck scan
        if: ${{ secrets.BLACKDUCK_URL != '' && secrets.BLACKDUCK_API_TOKEN != '' }}
        uses: synopsys-sig/detect-action@v1
        with:
          detect_opts: >
            --blackduck.url=${{ secrets.BLACKDUCK_URL }}
            --blackduck.api.token=${{ secrets.BLACKDUCK_API_TOKEN }}
            --detect.project.name=CPT-Public-Consumer
            --detect.project.version.name=CPT-4.0_RC1-SNAPSHOT
            --detect.source.path=.

      # 6. Fortify SCA scan + upload — OPTIONAL (conceptual equivalent)
      #    Needs Fortify CLI available (you may add a custom setup step or pre-baked runner).
      #    Set these secrets: FORTIFY_SSC_URL, FORTIFY_SSC_TOKEN
      - name: Fortify SCA scan & upload
        if: ${{ secrets.FORTIFY_SSC_URL != '' && secrets.FORTIFY_SSC_TOKEN != '' }}
        run: |
          # Update Fortify rules (similar to fortifyupdate)
          fortifyupdate -url "${{ secrets.FORTIFY_SSC_URL }}"
          fortifyupdate -showInstalledRules

          # Clean previous translation
          sourceanalyzer -b CPT-partner-consumer -clean

          # Translate source (same paths as in Jenkins)
          sourceanalyzer -b CPT-partner-consumer \
            pom.xml README.md src target

          # Scan and create FPR
          sourceanalyzer -b CPT-partner-consumer \
            -scan \
            -f cpt.partner-consumer1.fpr \
            -verbose \
            -logfile fortify-scan.log

          # Upload FPR to Fortify SSC (equivalent to Jenkins plugin upload)
          fortifyclient uploadFPR \
            -file cpt.partner-consumer1.fpr \
            -application "CPT-Public-Consumer" \
            -applicationVersion "release" \
            -url "${{ secrets.FORTIFY_SSC_URL }}" \
            -authtoken "${{ secrets.FORTIFY_SSC_TOKEN }}"
