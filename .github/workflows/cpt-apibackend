name: CPT API Backend CI

on:
  push:
    branches: [ main, CPT-API-4.5.0_RC ]
  workflow_dispatch:

jobs:
  build-and-scan:
    runs-on: self-hosted   # or ubuntu-latest if Maven/BlackDuck/Fortify are installed there

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      - name: Maven build (skip tests)
        run: mvn -B -Dmaven.test.skip=true clean install

      - name: Upload CPT API WAR
        uses: actions/upload-artifact@v4
        with:
          name: cpt-api-war
          path: cpt-web/target/*.war

      - name: Black Duck scan
        env:
          BLACKDUCK_URL: ${{ secrets.BLACKDUCK_URL }}
          BLACKDUCK_TOKEN: ${{ secrets.BLACKDUCK_API_TOKEN }}
        run: |
          curl -s -L -o synopsys-detect.jar https://detect.synopsys.com/detect.jar
          java -jar synopsys-detect.jar \
            --blackduck.url="$BLACKDUCK_URL" \
            --blackduck.api.token="$BLACKDUCK_TOKEN" \
            --detect.project.name=CPT-Backend \
            --detect.project.version.name=CPT-API-4.0_RC1 \
            --detect.source.path=.

      - name: Fortify scan
        run: |
          fortifyupdate -url https://wfsiaprd12196.gad.schneider-electric.com
          fortifyupdate -showInstalledRules
          sourceanalyzer -b CPT_API_SNAPSHOT -clean
          sourceanalyzer -b CPT_API_SNAPSHOT \
            cpt-business cpt-commons cpt-repo cpt-web pom.xml target
          sourceanalyzer -b CPT_API_SNAPSHOT \
            -scan -f cpt.api-snapshot1.fpr -verbose -logfile fortify-scan.log
